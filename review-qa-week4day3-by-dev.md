# QA 测试用例 Review 报告

**Review 对象**: 路线收藏测试用例  
**文档路径**: `workspace/test-cases-trails.md`  
**Review 日期**: 2026-02-28  
**Review 人**: Dev Agent  
**对应阶段**: Week 4 Day 3

---

## 1. 与代码一致性检查

### 1.1 API 路径一致性 ✅

| 测试用例 | 测试文档 | 代码实现 | 状态 |
|---------|---------|---------|------|
| TC-TRAIL-003 | `POST /trails/:id/favorite` | `POST /trails/:id/favorite` | ✅ 一致 |

### 1.2 HTTP 方法一致性 ⚠️

**问题发现**:
- 测试用例描述"再次调用取消收藏"，但未明确说明 HTTP 方法
- 代码实现中取消收藏使用 `DELETE /trails/:id/favorite`，而非 POST

**建议**: 测试用例应明确标注取消收藏的 HTTP 方法为 DELETE

### 1.3 响应状态码一致性 ⚠️

| 场景 | 测试文档 | 代码实现 | 状态 |
|-----|---------|---------|------|
| 收藏成功 | 200 | 200 (OK) | ✅ 一致 |
| 重复收藏 | 提示"已收藏该路线" | 409 Conflict | ⚠️ 不一致 |
| 路线不存在 | 未覆盖 | 404 Not Found | ❌ 缺失 |
| 未登录 | 未覆盖 | 401 Unauthorized | ❌ 缺失 |

**关键差异**:
- 代码中对重复收藏返回 **409 Conflict** 状态码，但测试用例未明确预期状态码
- 代码中错误响应格式为 `{ success: false, error: { code, message } }`，测试用例应与此对齐

### 1.4 响应数据结构一致性

代码中收藏成功返回的数据结构：
```json
{
  "success": true,
  "data": {
    "trailId": "string",
    "isFavorited": true,
    "favoriteCount": number,
    "favoritedAt": "ISO8601字符串"
  }
}
```

测试用例未验证响应数据结构，建议补充。

---

## 2. 覆盖完整性检查

### 2.1 正常场景覆盖

| 场景 | 是否覆盖 | 优先级 |
|-----|---------|--------|
| 收藏路线 | ✅ TC-TRAIL-003 | P1 |
| 取消收藏 | ✅ TC-TRAIL-003 | P1 |
| 检查收藏状态 | ❌ 未覆盖 | P2 |
| 获取收藏列表 | ❌ 未覆盖 | P2 |

**缺失的正常场景**:
1. **GET /trails/:id/favorite** - 检查收藏状态（代码已实现，测试未覆盖）
2. **GET /users/favorites** - 获取用户收藏列表（代码已实现，测试未覆盖）

### 2.2 异常场景覆盖

| 场景 | 是否覆盖 | 状态码 | 优先级 |
|-----|---------|--------|--------|
| 重复收藏 | ✅ TC-TRAIL-003-1 | 409 | P2 |
| 收藏不存在路线 | ❌ 未覆盖 | 404 | P2 |
| 取消未收藏的路线 | ❌ 未覆盖 | 404 | P2 |
| 未登录访问 | ❌ 未覆盖 | 401 | P1 |
| 无效路线ID格式 | ❌ 未覆盖 | 400 | P3 |

**关键缺失**:
- **TC-TRAIL-003-1 描述不准确**: 代码中对重复收藏返回 409 Conflict，但测试用例描述为"提示"，未明确状态码
- **取消收藏未测试**: TC-TRAIL-003 提到取消收藏，但没有专门的测试步骤和预期结果

---

## 3. 可执行性检查

### 3.1 测试步骤清晰度

| 测试用例 | 问题 | 建议 |
|---------|------|------|
| TC-TRAIL-003 | 步骤3"再次调用取消收藏"过于简略 | 明确使用 DELETE 方法，并验证返回结构 |
| TC-TRAIL-003 | 缺少具体的验证点 | 补充验证 `isFavorited`、`favoriteCount` 字段 |
| TC-TRAIL-003-1 | 缺少前置条件设置步骤 | 明确如何确保"路线已收藏"状态 |

### 3.2 前置条件完整性

当前前置条件仅"用户已登录"，建议补充：
- 测试路线 ID（有效/无效）
- 数据库初始状态（路线是否已发布）
- 用户当前的收藏状态

### 3.3 预期结果可验证性

**TC-TRAIL-003-1 问题**:
- 当前: "提示'已收藏该路线'"
- 建议: "返回 HTTP 409，响应体包含 `error.code: 'ALREADY_FAVORITED'`"

---

## 4. 遗漏场景识别

### 4.1 功能遗漏

| 遗漏场景 | 说明 | 建议优先级 |
|---------|------|-----------|
| 收藏未发布的路线 | 代码中检查 `isPublished: true` | P2 |
| 收藏列表分页 | 代码支持 page/limit 参数 | P2 |
| 收藏列表排序 | 代码支持多种排序方式 | P3 |
| 收藏列表城市筛选 | 代码支持 city 参数 | P3 |
| 并发收藏冲突 | 事务处理测试 | P3 |

### 4.2 边界条件遗漏

| 边界条件 | 说明 | 建议优先级 |
|---------|------|-----------|
| 路线ID为空/null | 参数校验 | P2 |
| 路线ID格式无效 | 非字符串或特殊字符 | P2 |
| 收藏数统计准确性 | 多次收藏/取消后计数 | P2 |

### 4.3 安全场景遗漏

| 安全场景 | 说明 | 建议优先级 |
|---------|------|-----------|
| Token 过期 | 401 响应 | P1 |
| 无效 Token | 401 响应 | P1 |
| 跨用户收藏操作 | 只能操作自己的收藏 | P2 |

---

## 5. Review 总结

### 5.1 总体评估

| 维度 | 评分 | 说明 |
|-----|------|------|
| 代码一致性 | ⭐⭐⭐☆☆ | 基本路径一致，但状态码和响应结构未对齐 |
| 覆盖完整性 | ⭐⭐☆☆☆ | 仅覆盖基础场景，大量异常场景缺失 |
| 可执行性 | ⭐⭐⭐☆☆ | 步骤描述较简略，缺少具体验证点 |
| 遗漏场景 | - | 发现 10+ 个未覆盖场景 |

### 5.2 关键问题清单

| 优先级 | 问题 | 建议修改 |
|-------|------|---------|
| 🔴 P1 | 未覆盖 401 未登录场景 | 新增 TC-TRAIL-003-2 |
| 🔴 P1 | 取消收藏方法不明确 | 明确使用 DELETE 方法 |
| 🟡 P2 | 重复收藏状态码未明确 | 明确预期 409 Conflict |
| 🟡 P2 | 缺少检查收藏状态测试 | 新增 GET /trails/:id/favorite 测试 |
| 🟡 P2 | 缺少获取收藏列表测试 | 新增 GET /users/favorites 测试 |
| 🟢 P3 | 响应数据结构未验证 | 补充字段验证预期 |

### 5.3 建议补充的测试用例

```markdown
### TC-TRAIL-003-2: 未登录用户收藏（异常场景）
| 项目 | 内容 |
|------|------|
| **API** | `POST /trails/:id/favorite` |
| **功能** | 未登录用户收藏拦截 |
| **前置条件** | 用户未登录（无 Token） |
| **测试步骤** | 1. 不带 Authorization 头调用 API |
| **预期结果** | 返回 401，错误码 `UNAUTHORIZED` |
| **优先级** | P1 |

### TC-TRAIL-003-3: 收藏不存在路线（异常场景）
| 项目 | 内容 |
|------|------|
| **API** | `POST /trails/:id/favorite` |
| **功能** | 收藏不存在路线异常处理 |
| **前置条件** | 用户已登录，路线 ID 不存在 |
| **测试步骤** | 1. 调用 API 传入无效路线 ID |
| **预期结果** | 返回 404，错误码 `TRAIL_NOT_FOUND` |
| **优先级** | P2 |

### TC-TRAIL-003-4: 取消未收藏的路线（异常场景）
| 项目 | 内容 |
|------|------|
| **API** | `DELETE /trails/:id/favorite` |
| **功能** | 取消收藏异常处理 |
| **前置条件** | 用户已登录，路线未收藏 |
| **测试步骤** | 1. 调用 DELETE 取消未收藏的路线 |
| **预期结果** | 返回 404，错误码 `FAVORITE_NOT_FOUND` |
| **优先级** | P2 |

### TC-TRAIL-003-5: 检查收藏状态
| 项目 | 内容 |
|------|------|
| **API** | `GET /trails/:id/favorite` |
| **功能** | 检查用户是否已收藏路线 |
| **前置条件** | 用户已登录 |
| **测试步骤** | 1. 调用 GET /trails/:id/favorite |
| **预期结果** | 返回 200，包含 `isFavorited` 布尔值 |
| **优先级** | P2 |

### TC-TRAIL-003-6: 获取用户收藏列表
| 项目 | 内容 |
|------|------|
| **API** | `GET /users/favorites` |
| **功能** | 获取当前用户收藏的路线列表 |
| **前置条件** | 用户已登录，有收藏记录 |
| **测试步骤** | 1. 调用 GET /users/favorites<br>2. 验证分页参数 |
| **预期结果** | 返回 200，包含路线列表和分页信息 |
| **优先级** | P2 |
```

---

## 6. 修改建议汇总

### 立即修改（阻塞性问题）
1. 明确 TC-TRAIL-003 中取消收藏使用 DELETE 方法
2. 明确 TC-TRAIL-003-1 预期返回 409 状态码

### 建议补充（高优先级）
1. 新增 401 未登录测试用例
2. 新增 404 路线不存在测试用例
3. 补充响应数据结构验证

### 后续迭代（中低优先级）
1. 补充 GET /trails/:id/favorite 测试
2. 补充 GET /users/favorites 测试
3. 补充边界条件测试

---

**Review 完成时间**: 2026-02-28  
**报告状态**: 待 QA 确认修改
