# 2026-03-01 会话记录

## 时间
- **日期**: 2026年3月1日
- **时段**: 凌晨 01:15 - 03:00 (Asia/Shanghai)

## 主要活动

### GitHub Actions APK 构建调试

**背景**: 山径APP Flutter 项目的 GitHub Actions 自动化构建一直失败，需要解决构建问题以生成 APK。

**问题分析**:
1. Build #15 显示成功但没有 artifact - `flutter build apk` 实际上没有生成 APK 文件
2. Build #16 失败 - 移除了 `|| true` 后，Flutter 构建直接报错
3. Build #17 失败 - 重写了 build.gradle，但仍然失败

**根本原因**:
- Flutter 3.24.0 与高德地图 SDK 存在兼容性问题
- GitHub Actions 的 Android 环境配置需要调整
- 网络问题导致代码推送到 GitHub 困难

**解决方案尝试**:
- 创建 Build #18，将 Flutter 版本降级到 3.19.0 以获得更好的兼容性
- 重写 GitHub Actions 工作流配置
- 调整定时任务检查频率为 20 分钟一次

**当前状态**:
- Build #18 的提交已在本地准备好
- 由于网络连接问题，多次推送 GitHub 失败
- 等待网络恢复后推送 Build #18

**关键决策**:
1. 将 Flutter 版本从 3.24.0 降级到 3.19.0
2. 定时任务检查频率从 5 分钟改为 20 分钟
3. 保留 Build #15 的工作流作为回滚备选

## 技术细节

### 修改的文件
- `.github/workflows/build.yml` - GitHub Actions 工作流配置

### 关键提交
- `e50dbeb8` - Rewrite workflow: fix build.gradle and simplify steps
- `5e81eaf0` - Downgrade Flutter to 3.19.0 for better compatibility (本地，未推送)

### 定时任务调整
- 任务 ID: `9eb65bad-be4c-4f45-96b7-fc6cb318f536`
- 频率: 5分钟 → 20分钟
- 用途: 检查 GitHub Actions 构建状态

## 待办事项

### 高优先级
- [ ] 等待网络恢复，推送 Build #18 到 GitHub
- [ ] 验证 Flutter 3.19.0 与高德地图 SDK 的兼容性
- [ ] 确认 APK 能正确生成并上传 artifact

### 中优先级
- [ ] 如果 Build #18 失败，考虑回滚到 Build #15 的配置
- [ ] 添加更详细的构建日志以便调试
- [ ] 考虑使用 Flutter 稳定版本矩阵测试多个版本

## 经验教训

1. **Flutter 版本兼容性**: 新版本 Flutter 可能与第三方 SDK 存在兼容性问题，需要测试验证
2. **CI/CD 调试**: 使用 `|| true` 掩盖错误会隐藏真正的问题，应该让构建在错误时失败
3. **网络问题**: 推送代码时遇到网络问题，需要耐心等待或寻找替代方案

## 相关链接
- 仓库: https://github.com/suyustudio/shanjing-app
- 构建历史: https://github.com/suyustudio/shanjing-app/actions

---

## 下午会话记录 (14:50 - 17:50)

### 1. GitHub Actions 构建持续调试

**构建历史更新**:
| 构建 | 状态 | 提交信息 | 时间 |
|------|------|----------|------|
| #27 | ❌ 失败 | Fix build.gradle: use hardcoded version | 17:41 |
| #26 | ❌ 失败 | Add minimal Flutter build test workflow | 14:50 |
| #25 | ❌ 失败 | Fix artifact path: use wildcard to find APK | 12:11 |
| #24 | ❌ 失败 | Remove tail to show full build output | 08:56 |
| #23 | ✅ 成功 | Fix YAML syntax: remove duplicate env | 08:35 |

**Build #26 错误分析**:
```
Could not get unknown property 'versionCode' for extension 'flutter'
```
问题：`build.gradle` 中使用了 `flutter.versionCode` 等属性，但重新创建项目后这些属性不存在。

**修复措施 (Build #27)**:
- 将 `flutter.versionCode` 改为硬编码 `versionCode = 1`
- 将 `flutter.versionName` 改为硬编码 `versionName = "1.0.0"`
- 将 `flutter.compileSdkVersion` 改为硬编码 `compileSdk = 34`
- 将 `flutter.ndkVersion` 改为硬编码 `ndkVersion = "25.1.8937393"`

**Build #27 结果**: 仍然失败，运行了约 7 分钟

---

### 2. 导航功能开发

**实现内容**:
- ✅ GPS 精度过滤（<10m 才使用）
- ✅ 偏航检测（偏离路线 50m 以上且连续 3 次确认才提示）
- ✅ 语音播报（使用 flutter_tts）
- ✅ 导航进度显示（剩余距离、预计时间、完成百分比）

**新增依赖**:
- `flutter_tts: ^4.0.2` - 用于语音导航

**修改文件**:
- `lib/screens/navigation_screen.dart` - 完全重写，实现增强版导航
- `pubspec.yaml` - 添加 flutter_tts 依赖

---

### 3. Release 流程问题分析

**主要问题识别**:
1. **重新创建 Flutter 项目** - `flutter create` 覆盖了现有的 `lib/` 代码
2. **build.gradle 被完全覆盖** - 可能导致依赖丢失
3. **APK 未生成** - 构建失败或路径问题

**创建的修复方案**:
- 新建 `.github/workflows/build-fixed.yml` - 不使用 `flutter create`，直接使用现有项目

---

### 4. 定时任务状态

**GitHub Actions 检查任务**:
- 任务 ID: `9eb65bad-be4c-4f45-96b7-fc6cb318f536`
- 频率: 每小时检查一次
- 状态: 持续监控中，Build #23 后连续 4 次失败

---

### 5. 用户指令

**关键决策**:
- 继续推进开发，不要被 GitHub Actions 构建问题卡住
- 按 1、2、3 顺序推进：完善页面 → GPS精度过滤 → 语音播报
- 让 dev 分析 release 流程问题

**新增需求**:
- 添加上海古美公园路线（方便用户测试，距离很近）

---

## 今日关键决策

1. **构建问题**: 识别出 `flutter.versionCode` 等属性不存在的问题，已修复但 Build #27 仍失败
2. **开发策略**: 不因构建问题阻塞开发，继续推进 Flutter 功能开发
3. **导航功能**: 完成 GPS 精度过滤、偏航检测、语音播报三大核心功能

## 待办事项更新

### 高优先级
- [ ] 查看 Build #27 详细错误日志，继续修复构建问题
- [ ] 推送导航功能代码到 GitHub（网络恢复后）
- [ ] 让 product 添加上海古美公园路线

### 中优先级
- [ ] 测试修复版工作流 `build-fixed.yml`
- [ ] 完善其他页面（地图页、我的页）
- [ ] 添加更多单元测试

## 经验教训

1. **GitHub Actions 调试**: 需要查看详细日志才能定位问题，不能盲目猜测
2. **Flutter 构建**: `flutter create` 会覆盖现有代码，CI 中应避免使用
3. **并行推进**: 构建问题和功能开发可以并行，不要因为构建阻塞开发进度

---
*记录时间: 2026-03-01 18:00*
