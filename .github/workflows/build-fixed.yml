name: Build and Release APK (Fixed)

on:
  push:
    branches: [ main ]
  workflow_dispatch:

env:
  AMAP_KEY: ${{ secrets.AMAP_KEY }}

jobs:
  build:
    runs-on: ubuntu-latest
    
    steps:
    - uses: actions/checkout@v4
    
    - name: Setup Java
      uses: actions/setup-java@v4
      with:
        java-version: '17'
        distribution: 'temurin'
    
    - name: Setup Flutter
      uses: subosito/flutter-action@v2
      with:
        flutter-version: '3.19.0'
        channel: 'stable'
    
    - name: Check Flutter project
      run: |
        echo "=== Project Structure ==="
        ls -la
        echo "=== pubspec.yaml ==="
        cat pubspec.yaml
    
    - name: Enable Android platform
      run: flutter config --enable-android
    
    - name: Install dependencies
      run: flutter pub get
    
    - name: Setup Android signing
      run: |
        cd android
        mkdir -p app
        # Generate keystore
        keytool -genkey -v -keystore app/shanjing.keystore -alias shanjing \
          -keyalg RSA -keysize 2048 -validity 10000 \
          -storepass shanjing123 -keypass shanjing123 \
          -dname "CN=Shanjing App, OU=Development, O=SuyuStudio, L=Hangzhou, ST=Zhejiang, C=CN"
        # Create key.properties
        cat > key.properties << EOF
        storePassword=shanjing123
        keyPassword=shanjing123
        keyAlias=shanjing
        storeFile=app/shanjing.keystore
        EOF
    
    - name: Configure Android build
      run: |
        # Update project-level build.gradle with Kotlin version
        cd android
        cat > build.gradle << 'EOF'
        buildscript {
            ext.kotlin_version = '1.9.10'
            repositories {
                google()
                mavenCentral()
            }
            dependencies {
                classpath 'com.android.tools.build:gradle:8.1.0'
                classpath "org.jetbrains.kotlin:kotlin-gradle-plugin:$kotlin_version"
            }
        }
        
        allprojects {
            repositories {
                google()
                mavenCentral()
            }
        }
        
        rootProject.buildDir = '../build'
        subprojects {
            project.buildDir = "${rootProject.buildDir}/${project.name}"
        }
        subprojects {
            project.evaluationDependsOn(':app')
        }
        
        tasks.register("clean", Delete) {
            delete rootProject.buildDir
        }
        EOF
        
        # Update app-level build.gradle with signing config
        cd app
        cat > build.gradle << 'EOF'
        plugins {
            id "com.android.application"
            id "kotlin-android"
            id "dev.flutter.flutter-gradle-plugin"
        }
        
        def localProperties = new Properties()
        def localPropertiesFile = rootProject.file('local.properties')
        if (localPropertiesFile.exists()) {
            localPropertiesFile.withReader('UTF-8') { reader ->
                localProperties.load(reader)
            }
        }
        
        def keystoreProperties = new Properties()
        def keystorePropertiesFile = rootProject.file('key.properties')
        if (keystorePropertiesFile.exists()) {
            keystorePropertiesFile.withReader('UTF-8') { reader ->
                keystoreProperties.load(reader)
            }
        }
        
        android {
            namespace = "com.suyustudio.shanjing"
            compileSdk = 34
            ndkVersion = "25.1.8937393"
            
            compileOptions {
                sourceCompatibility = JavaVersion.VERSION_17
                targetCompatibility = JavaVersion.VERSION_17
            }
            
            kotlinOptions {
                jvmTarget = '17'
            }
            
            lintOptions {
                disable 'InvalidPackage'
                checkReleaseBuilds false
            }
            
            defaultConfig {
                applicationId = "com.suyustudio.shanjing"
                minSdk = 21
                targetSdk = 34
                versionCode = 1
                versionName = "1.0.0"
            }
            
            signingConfigs {
                release {
                    keyAlias = keystoreProperties['keyAlias']
                    keyPassword = keystoreProperties['keyPassword']
                    storeFile = keystoreProperties['storeFile'] ? file(keystoreProperties['storeFile']) : null
                    storePassword = keystoreProperties['storePassword']
                }
            }
            
            buildTypes {
                release {
                    signingConfig = signingConfigs.release
                    minifyEnabled = false
                    shrinkResources = false
                    proguardFiles getDefaultProguardFile('proguard-android.txt'), 'proguard-rules.pro'
                }
            }
        }
        
        flutter {
            source = '../..'
        }
        EOF
    
    - name: Build APK (with verbose output)
      run: |
        flutter build apk --release --verbose 2>&1 | tee build.log
        echo "=== Build Result ==="
        echo "Exit code: $?"
    
    - name: Find APK files
      run: |
        echo "=== All APK files ==="
        find . -name "*.apk" -type f 2>/dev/null
        echo "=== build directory structure ==="
        ls -la build/ 2>/dev/null || echo "build directory not found"
        ls -la build/app/ 2>/dev/null || echo "build/app directory not found"
        ls -la build/app/outputs/ 2>/dev/null || echo "build/app/outputs directory not found"
    
    - name: Upload APK
      if: always()
      uses: actions/upload-artifact@v4
      with:
        name: shanjing-apk
        path: build/app/outputs/**/*.apk
        if-no-files-found: warn
    
    - name: Upload build logs
      if: always()
      uses: actions/upload-artifact@v4
      with:
        name: build-logs
        path: build.log
        if-no-files-found: ignore
