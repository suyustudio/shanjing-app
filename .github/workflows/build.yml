name: Build and Release APK

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]
  workflow_dispatch:

env:
  AMAP_KEY: ${{ secrets.AMAP_KEY }}

jobs:
  build:
    runs-on: ubuntu-latest
    
    steps:
    - uses: actions/checkout@v4
    
    - name: Setup Java
      uses: actions/setup-java@v4
      with:
        java-version: '17'
        distribution: 'temurin'
    
    - name: Setup Flutter
      uses: subosito/flutter-action@v2
      with:
        flutter-version: '3.16.0'
        channel: 'stable'
    
    - name: Create Android platform
      run: |
        # Create Flutter Android project structure
        flutter config --enable-android
        flutter create --platforms=android . --org com.suyustudio.shanjing --project-name shanjing
    
    - name: Install dependencies
      run: flutter pub get
    
    - name: Setup Android signing
      run: |
        cd android
        mkdir -p app
        # Generate keystore
        keytool -genkey -v -keystore app/shanjing.keystore -alias shanjing \
          -keyalg RSA -keysize 2048 -validity 10000 \
          -storepass shanjing123 -keypass shanjing123 \
          -dname "CN=Shanjing App, OU=Development, O=SuyuStudio, L=Hangzhou, ST=Zhejiang, C=CN"
        # Create key.properties
        cat > key.properties << EOF
        storePassword=shanjing123
        keyPassword=shanjing123
        keyAlias=shanjing
        storeFile=app/shanjing.keystore
        EOF
    
    - name: Configure Android build
      run: |
        # Update build.gradle with signing config
        cd android/app
        cat > build.gradle << 'EOF'
        plugins {
            id "com.android.application"
            id "kotlin-android"
            id "dev.flutter.flutter-gradle-plugin"
        }
        
        def localProperties = new Properties()
        def localPropertiesFile = rootProject.file('local.properties')
        if (localPropertiesFile.exists()) {
            localPropertiesFile.withReader('UTF-8') { reader ->
                localProperties.load(reader)
            }
        }
        
        def keystoreProperties = new Properties()
        def keystorePropertiesFile = rootProject.file('key.properties')
        if (keystorePropertiesFile.exists()) {
            keystorePropertiesFile.withReader('UTF-8') { reader ->
                keystoreProperties.load(reader)
            }
        }
        
        android {
            namespace = "com.suyustudio.shanjing"
            compileSdk = 34
            ndkVersion = "25.1.8937393"
            
            compileOptions {
                sourceCompatibility = JavaVersion.VERSION_1_8
                targetCompatibility = JavaVersion.VERSION_1_8
            }
            
            kotlinOptions {
                jvmTarget = '1.8'
            }
            
            defaultConfig {
                applicationId = "com.suyustudio.shanjing"
                minSdk = 21
                targetSdk = 34
                versionCode = 1
                versionName = "1.0.0"
            }
            
            signingConfigs {
                release {
                    keyAlias = keystoreProperties['keyAlias']
                    keyPassword = keystoreProperties['keyPassword']
                    storeFile = keystoreProperties['storeFile'] ? file(keystoreProperties['storeFile']) : null
                    storePassword = keystoreProperties['storePassword']
                }
            }
            
            buildTypes {
                release {
                    signingConfig = signingConfigs.release
                    minifyEnabled = false
                    shrinkResources = false
                }
            }
        }
        
        flutter {
            source = '../..'
        }
        EOF
    
    - name: Update AndroidManifest
      run: |
        cat > android/app/src/main/AndroidManifest.xml << EOF
        <manifest xmlns:android="http://schemas.android.com/apk/res/android">
            <application
                android:label="山径"
                android:name="\${applicationName}"
                android:icon="@mipmap/ic_launcher">
                <activity
                    android:name=".MainActivity"
                    android:exported="true"
                    android:launchMode="singleTop"
                    android:theme="@style/LaunchTheme"
                    android:configChanges="orientation|keyboardHidden|keyboard|screenSize|smallestScreenSize|locale|layoutDirection|fontScale|screenLayout|density|uiMode"
                    android:hardwareAccelerated="true"
                    android:windowSoftInputMode="adjustResize">
                    <meta-data
                        android:name="io.flutter.embedding.android.NormalTheme"
                        android:resource="@style/NormalTheme" />
                    <intent-filter>
                        <action android:name="android.intent.action.MAIN"/>
                        <category android:name="android.intent.category.LAUNCHER"/>
                    </intent-filter>
                </activity>
                <meta-data
                    android:name="flutterEmbedding"
                    android:value="2" />
                <meta-data
                    android:name="com.amap.api.v2.apikey"
                    android:value="${{ secrets.AMAP_KEY }}" />
            </application>
            <uses-permission android:name="android.permission.INTERNET"/>
            <uses-permission android:name="android.permission.ACCESS_FINE_LOCATION"/>
            <uses-permission android:name="android.permission.ACCESS_COARSE_LOCATION"/>
            <uses-permission android:name="android.permission.ACCESS_BACKGROUND_LOCATION"/>
        </manifest>
        EOF
    
    - name: Build APK
      run: |
        set -e
        flutter build apk --release
        echo "=== Find APK files ==="
        find . -name "*.apk" -type f
        ls -la build/app/outputs/flutter-apk/ 2>/dev/null || echo "flutter-apk directory not found"
        ls -la build/app/outputs/apk/release/ 2>/dev/null || echo "apk/release directory not found"
    
    - name: Upload APK
      if: always()
      uses: actions/upload-artifact@v4
      with:
        name: shanjing-apk
        path: '**/*.apk'
        if-no-files-found: warn
    
    - name: Create Release
      if: github.event_name == 'push' && github.ref == 'refs/heads/main'
      uses: softprops/action-gh-release@v1
      with:
        files: '**/*.apk'
        tag_name: v0.1.${{ github.run_number }}
        name: Release v0.1.${{ github.run_number }}
        body: |
          山径APP 自动构建版本
          
          构建时间: ${{ github.event.head_commit.timestamp }}
          提交: ${{ github.event.head_commit.message }}
        draft: false
        prerelease: true
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      continue-on-error: true
