# Flutter 轨迹跟随算法调研

## 1. GPS 点实时匹配到路线轨迹的算法

### 核心算法：隐马尔可夫模型 (HMM) Map Matching

**原理**：
- 将 GPS 点视为观测序列，道路网络节点为隐藏状态
- 计算发射概率（GPS点到候选道路的距离）和转移概率（相邻道路间的连通性）
- 使用 Viterbi 算法求解最优路径

**关键步骤**：
1. **候选点生成**：以 GPS 点为中心，搜索半径 R（通常 20-50m）内的道路段
2. **发射概率**：`P(z|r) = (1/√(2π)σ) * exp(-d²/2σ²)`，d 为 GPS 点到道路的垂直距离
3. **转移概率**：基于道路连通性和方向一致性计算
4. **路径解码**：Viterbi 动态规划求最大概率路径

### 简化方案：几何匹配

**最近点投影法**：
- 计算 GPS 点到各道路段的垂直投影距离
- 选择距离最短且方向夹角 < 45° 的道路段
- 时间复杂度 O(n)，适合实时场景

---

## 2. 误差计算方法（<10米）

### 距离误差公式

**Haversine 公式**（计算两点球面距离）：
```
a = sin²(Δφ/2) + cos(φ1) * cos(φ2) * sin²(Δλ/2)
c = 2 * atan2(√a, √(1-a))
d = R * c  // R = 6371000m（地球半径）
```

### 误差指标

| 指标 | 公式 | 目标值 |
|------|------|--------|
| 平均绝对误差 (MAE) | `Σ|d_i| / n` | < 10m |
| 均方根误差 (RMSE) | `√(Σd_i² / n)` | < 15m |
| 最大误差 | `max(d_i)` | < 30m |

### GPS 精度过滤

- **精度阈值**：`location.accuracy <= 10`（仅使用高精度点）
- **速度过滤**：剔除 `speed > 120km/h` 的异常点
- **距离过滤**：相邻点距离 < 2m 视为静止

---

## 3. 推荐技术方案

### 方案 A：服务端 Map Matching（推荐）

**实现**：
- 使用 Mapbox Map Matching API / OSRM
- Flutter 端：收集 GPS 点 → 批量上传 → 获取匹配路径
- 精度：5-10m，支持复杂路口

**优点**：算法成熟，无需维护路网数据
**缺点**：依赖网络，有延迟

### 方案 B：客户端轻量匹配

**实现**：
- 预加载路线 Polyline 数据
- 实时计算 GPS 点到 Polyline 的最近点
- 使用 `maps_tool` 或自定义几何计算

```dart
// 核心代码示意
import 'package:maps_tool/maps_tool.dart';

LatLng matchedPoint = PolylineUtil.snapToPath(
  path: routePoints,
  point: currentGPS,
  tolerance: 20, // 米
);
```

**优点**：离线可用，响应快
**缺点**：仅支持已知路线，复杂路口处理弱

### 方案 C：卡尔曼滤波 + 几何匹配

**实现**：
- 使用 `tracelet` 插件做 GPS 平滑
- 结合传感器融合（陀螺仪/加速度计）
- 几何匹配到预规划路线

**优点**：抖动小，体验流畅
**缺点**：实现复杂，需调参

---

## 结论

| 场景 | 推荐方案 |
|------|----------|
| 有网络、高精度要求 | 方案 A：服务端 Map Matching |
| 离线、固定路线 | 方案 B：客户端几何匹配 |
| 运动追踪、平滑优先 | 方案 C：卡尔曼滤波 |

**MVP 建议**：先用方案 B 实现基础功能，精度要求 <10m 时切换到方案 A。
