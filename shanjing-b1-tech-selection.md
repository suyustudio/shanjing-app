# 山径APP - 技术选型确认文档 (B1)

> **文档版本**: v1.0  
> **制定日期**: 2026-02-27  
> **文档状态**: 已确认  
> **对应阶段**: Week 2 - B1 技术选型确认

---

## 1. 选型概述

本文档基于《山径APP - 技术架构设计文档》进行技术选型的最终确认，明确各技术栈的具体版本和选型理由，作为后续开发的技术基准。

---

## 2. 客户端技术选型

### 2.1 跨平台框架: Flutter

| 项目 | 确认内容 |
|------|----------|
| **技术选型** | Flutter |
| **版本确认** | **3.16.0+ (稳定版)** |
| **Dart版本** | **3.2.0+** |
| **选择状态** | ✅ 已确认 |

#### 选型理由

| 维度 | 评估结果 |
|------|----------|
| **跨平台能力** | 一套代码同时支持iOS/Android，MVP阶段节省50%+开发成本 |
| **性能表现** | 自绘引擎，性能接近原生，地图渲染流畅度满足导航需求 |
| **生态支持** | 高德SDK提供官方Flutter插件，社区组件丰富 |
| **团队匹配** | 单移动端工程师可独立完成双端开发 |
| **热更新** | 支持Code Push，紧急修复无需发版 |

#### 备选方案对比

| 方案 | 优点 | 缺点 | 决策 |
|------|------|------|------|
| Flutter 3.16+ | 跨平台、性能高、生态好 | 包体积略大 | ✅ **已确认** |
| React Native 0.72+ | 生态成熟、Web团队易上手 | 地图性能一般 | ❌ 不适用 |
| 原生双端 (Swift/Kotlin) | 性能最佳 | 开发成本高 | ❌ MVP不适用 |

#### 关键依赖包版本

```yaml
# pubspec.yaml 核心依赖
dependencies:
  flutter:
    sdk: flutter
  
  # 状态管理
  flutter_riverpod: ^2.4.0
  riverpod_annotation: ^2.3.0
  
  # 高德地图 SDK
  amap_flutter_map: ^3.0.0
  amap_flutter_location: ^3.0.0
  
  # 本地存储
  drift: ^2.14.0
  sqlite3_flutter_libs: ^0.5.0
  shared_preferences: ^2.2.0
  
  # 网络请求
  dio: ^5.4.0
  retrofit: ^4.0.0
  
  # 微信SDK
  fluwx: ^4.0.0
  
  # 其他工具
  freezed_annotation: ^2.4.0
  json_annotation: ^4.8.0
  go_router: ^13.0.0
```

---

## 3. 后端技术选型

### 3.1 运行时与框架

| 项目 | 确认内容 |
|------|----------|
| **运行时** | Node.js |
| **版本确认** | **18.19.0 LTS** |
| **框架** | NestJS |
| **框架版本** | **10.3.0+** |
| **语言** | TypeScript |
| **TS版本** | **5.3.0+** |
| **选择状态** | ✅ 已确认 |

#### 技术栈组合

```
运行时: Node.js 18.19.0 LTS
框架: NestJS 10.3.0
语言: TypeScript 5.3.0
ORM: Prisma 5.7.0
API文档: Swagger/OpenAPI 3.0
测试: Jest 29.7.0 + Supertest 6.3.0
```

#### 选型理由

| 维度 | 评估结果 |
|------|----------|
| **开发效率** | JavaScript全栈，前后端可复用部分逻辑 |
| **生态丰富** | npm包管理，NestJS企业级架构成熟 |
| **实时能力** | WebSocket支持好，适合导航实时数据 |
| **类型安全** | TypeScript提供编译时类型检查 |
| **部署简单** | Docker化部署，CI/CD流程成熟 |

#### 备选方案对比

| 方案 | 优点 | 缺点 | 决策 |
|------|------|------|------|
| Node.js + NestJS | 全栈JS、生态好、开发快 | 单线程CPU密集型弱 | ✅ **已确认** |
| Go + Gin | 性能高、并发好 | 学习成本、生态小 | ❌ 开发效率优先 |
| Java + Spring Boot | 生态成熟、企业级 | 启动慢、资源占用高 | ❌ 轻量优先 |

---

### 3.2 数据库选型

| 项目 | 确认内容 |
|------|----------|
| **主数据库** | PostgreSQL |
| **版本确认** | **15.4+** |
| **空间扩展** | PostGIS 3.3+ |
| **ORM工具** | Prisma 5.7.0+ |
| **选择状态** | ✅ 已确认 |

#### 选型理由

| 维度 | 评估结果 |
|------|----------|
| **空间数据** | PostGIS扩展提供强大的地理空间数据支持 |
| **性能** | 支持复杂查询，JSON字段存储灵活 |
| **可靠性** | ACID事务支持，数据一致性保障 |
| **生态** | Prisma ORM支持良好，开发体验佳 |

#### 数据库配置

```yaml
# docker-compose.yml
services:
  postgres:
    image: postgis/postgis:15-3.3
    environment:
      POSTGRES_DB: shanjing
      POSTGRES_USER: app
      POSTGRES_PASSWORD: ${DB_PASSWORD}
    volumes:
      - postgres_data:/var/lib/postgresql/data
    ports:
      - "5432:5432"
```

---

### 3.3 缓存与存储

| 组件 | 选型 | 版本 | 用途 |
|------|------|------|------|
| **缓存** | Redis | 7.2+ | 会话、热点数据、限流 |
| **对象存储** | 阿里云OSS | - | 图片、GPX文件、离线包 |
| **本地存储** | SQLite (drift) | 3.44+ | 移动端离线数据 |

#### Redis配置

```yaml
services:
  redis:
    image: redis:7.2-alpine
    command: redis-server --appendonly yes --maxmemory 256mb --maxmemory-policy allkeys-lru
    volumes:
      - redis_data:/data
    ports:
      - "6379:6379"
```

---

## 4. 地图服务选型

### 4.1 地图SDK: 高德开放平台

| 项目 | 确认内容 |
|------|----------|
| **地图服务** | 高德开放平台 |
| **SDK版本** | **Android/iOS SDK 9.7.0+** |
| **Flutter插件** | amap_flutter_map 3.0.0+ |
| **定位SDK** | 高德定位SDK 6.4.0+ |
| **选择状态** | ✅ 已确认 |

#### 功能模块与SDK对应

| 功能模块 | 高德SDK能力 | 使用方式 | 版本要求 |
|----------|-------------|----------|----------|
| 地图显示 | 2D/3D地图 | amap_flutter_map | 3.0.0+ |
| 离线地图 | 按城市/区域下载 | 原生SDK封装 | 9.7.0+ |
| 定位服务 | GPS+北斗双模 | amap_flutter_location | 3.0.0+ |
| 轨迹绘制 | 折线/多边形覆盖物 | amap_flutter_map | 3.0.0+ |
| 路径规划 | 步行路径规划 | 高德Web API | - |

#### 选型理由

| 维度 | 评估结果 |
|------|----------|
| **数据准确** | 国内地图数据最准确，山路、步道覆盖全 |
| **北斗支持** | 原生支持北斗+GPS双模定位，符合产品卖点 |
| **离线能力** | 支持离线地图下载，满足核心需求 |
| **合规性** | 国内地图资质齐全，避免政策风险 |

#### 备选方案

| 方案 | 优点 | 缺点 | 决策 |
|------|------|------|------|
| 高德SDK | 国内数据准、北斗支持、合规 | 海外数据弱 | ✅ **已确认** |
| Mapbox | 全球数据、样式定制强 | 国内合规风险 | ❌ 备选方案 |
| 百度地图 | 国内数据准 | 北斗支持弱、生态小 | ❌ 不适用 |

---

## 5. 第三方服务选型

### 5.1 认证与社交

| 服务 | 选型 | 版本/说明 |
|------|------|-----------|
| **微信登录** | 微信开放平台SDK | fluwx 4.0.0+ |
| **微信分享** | 微信SDK | 支持会话/朋友圈分享 |
| **短信服务** | 阿里云短信 | 手机号绑定备用 |

### 5.2 推送服务

| 服务 | 选型 | 说明 |
|------|------|------|
| **消息推送** | 极光推送 JPush | 5.0.0+，支持离线提醒 |

### 5.3 云服务

| 服务 | 选型 | 用途 |
|------|------|------|
| **云服务器** | 阿里云ECS | 后端API部署 |
| **对象存储** | 阿里云OSS | 图片、文件存储 |
| **CDN** | 阿里云CDN | 静态资源加速 |
| **数据库** | 阿里云RDS PostgreSQL | 生产数据库 |

---

## 6. 开发工具与环境

### 6.1 开发环境

| 工具 | 版本 | 用途 |
|------|------|------|
| **Docker** | 24.0+ | 开发环境容器化 |
| **Docker Compose** | 2.20+ | 多服务编排 |
| **Git** | 2.40+ | 版本控制 |
| **Node.js** | 18.19.0 LTS | 后端开发 |
| **Flutter SDK** | 3.16.0+ | 移动端开发 |

### 6.2 IDE与插件

| IDE | 推荐插件 |
|-----|----------|
| **VS Code** | Flutter、Dart、ESLint、Prettier、Prisma |
| **Android Studio** | Flutter插件、Dart插件 |
| **Xcode** | 15.0+ (iOS构建) |

### 6.3 代码规范工具

| 工具 | 版本 | 用途 |
|------|------|------|
| **ESLint** | 8.55.0+ | TypeScript代码规范 |
| **Prettier** | 3.1.0+ | 代码格式化 |
| **Husky** | 8.0.0+ | Git钩子管理 |
| **Commitlint** | 18.4.0+ | 提交信息规范 |

---

## 7. 技术选型总览

### 7.1 技术栈全景图

```
┌─────────────────────────────────────────────────────────────────────────┐
│                              山径APP 技术栈                              │
├─────────────────────────────────────────────────────────────────────────┤
│                                                                         │
│  ┌─────────────────┐    ┌─────────────────┐    ┌─────────────────┐     │
│  │   客户端 (Flutter) │    │   后端 (Node.js)  │    │   数据层         │     │
│  │   v3.16.0+       │    │   v18.19.0 LTS   │    │                 │     │
│  ├─────────────────┤    ├─────────────────┤    ├─────────────────┤     │
│  │ • Dart 3.2+     │    │ • NestJS 10.3+  │    │ • PostgreSQL 15 │     │
│  │ • Riverpod 2.4+ │◄──►│ • TypeScript 5.3│◄──►│ • PostGIS 3.3   │     │
│  │ • 高德SDK 3.0+  │    │ • Prisma 5.7+   │    │ • Redis 7.2+    │     │
│  │ • Drift 2.14+   │    │ • Jest 29.7+    │    │ • 阿里云OSS     │     │
│  └─────────────────┘    └─────────────────┘    └─────────────────┘     │
│           │                      │                      │              │
│           ▼                      ▼                      ▼              │
│  ┌─────────────────┐    ┌─────────────────┐    ┌─────────────────┐     │
│  │   第三方服务     │    │   部署运维       │    │   开发工具       │     │
│  ├─────────────────┤    ├─────────────────┤    ├─────────────────┤     │
│  │ • 微信SDK       │    │ • Docker 24+    │    │ • VS Code       │     │
│  │ • 极光推送      │    │ • Nginx         │    │ • Git 2.40+     │     │
│  │ • 阿里云ECS     │    │ • CI/CD (GitHub │    │ • ESLint/Prettier│    │
│  │ • 阿里云CDN     │    │   Actions)      │    │ • Husky         │     │
│  └─────────────────┘    └─────────────────┘    └─────────────────┘     │
│                                                                         │
└─────────────────────────────────────────────────────────────────────────┘
```

### 7.2 版本锁定表

| 层级 | 组件 | 版本 | 锁定原因 |
|------|------|------|----------|
| 客户端 | Flutter | 3.16.0+ | 稳定版，支持Impeller渲染引擎 |
| 客户端 | Dart | 3.2.0+ | 跟随Flutter版本 |
| 客户端 | 高德Flutter插件 | 3.0.0+ | 与原生SDK 9.7+兼容 |
| 后端 | Node.js | 18.19.0 LTS | 长期支持版，稳定可靠 |
| 后端 | NestJS | 10.3.0+ | 最新稳定版，API成熟 |
| 后端 | Prisma | 5.7.0+ | 支持PostgreSQL 15 |
| 数据库 | PostgreSQL | 15.4+ | 性能优化，JSON支持增强 |
| 数据库 | PostGIS | 3.3.0+ | 空间数据支持 |
| 缓存 | Redis | 7.2.0+ | 性能提升，新数据结构 |

---

## 8. 风险评估与备选方案

### 8.1 技术风险

| 风险ID | 风险描述 | 概率 | 影响 | 应对措施 |
|--------|----------|------|------|----------|
| T1 | 高德离线地图功能不稳定 | 中 | 高 | Week 2完成技术预研验证；准备Mapbox备选方案 |
| T2 | Flutter 3.16与高德插件兼容问题 | 低 | 高 | 提前验证插件兼容性；准备降级到3.13方案 |
| T3 | PostgreSQL空间查询性能瓶颈 | 低 | 中 | 预留索引优化时间；准备读写分离方案 |

### 8.2 备选方案触发条件

| 备选方案 | 触发条件 | 切换成本 |
|----------|----------|----------|
| Mapbox替换高德 | Week 3结束时离线地图验证失败 | 高（2周） |
| Flutter降级到3.13 | 高德插件兼容性问题无法解决 | 低（2天） |
| 增加Redis缓存层 | PostgreSQL查询性能不达标 | 中（3天） |

---

## 9. 确认签字

| 角色 | 签字 | 日期 |
|------|------|------|
| 技术负责人 | | |
| 后端开发 | | |
| 移动端开发 | | |
| 产品经理 | | |

---

## 10. 附录

### 10.1 参考文档

- [Flutter 3.16 Release Notes](https://docs.flutter.dev/release/whats-new)
- [NestJS 10 Documentation](https://docs.nestjs.com/)
- [高德地图SDK文档](https://lbs.amap.com/api/flutter-sdk/summary)
- [PostgreSQL 15 Documentation](https://www.postgresql.org/docs/15/)
- [Prisma Documentation](https://www.prisma.io/docs)

### 10.2 文档变更记录

| 版本 | 日期 | 变更内容 | 作者 |
|------|------|----------|------|
| v1.0 | 2026-02-27 | 初始版本，确认所有技术选型 | - |

---

> **文档说明**: 本文档作为Week 2 B1任务的交付物，所有技术选型已确认并锁定版本。后续开发严格按此文档执行，如需变更需走变更流程。
