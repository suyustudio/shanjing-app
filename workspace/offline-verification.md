# Week 5 Day 6 离线地图功能验证报告

> 验证时间: 2026-02-28  
> 验证方式: 代码审查 + 配置检查

---

## 1. 离线地图下载按钮检查 ✅

### 1.1 按钮位置
- **地图页**: 右下角控制按钮组上方
- **路线详情页**: 底部操作栏右侧

### 1.2 代码实现状态

| 位置 | 状态 | 说明 |
|------|------|------|
| `map_screen.dart` | ✅ 已实现 | `_buildControlButton(icon: Icons.download)` |
| `trail_detail_screen.dart` | ✅ 已实现 | `IconButton(icon: Icons.download_outlined)` |

### 1.3 按钮功能

**地图页下载按钮**:
```dart
// 触发弹窗
_showOfflineDownloadDialog()

// 显示内容:
- 当前路线名称
- 下载范围: 周边 500m
- 地图级别: 14-15级
- 预估大小: ~12MB
- 进度条 (下载中)
```

**路线详情页下载按钮**:
```dart
void _downloadTrail() {
  // TODO: 下载路线
  ScaffoldMessenger.of(context).showSnackBar(
    const SnackBar(content: Text('开始下载路线...')),
  );
}
```

---

## 2. 离线地图配置检查 ✅

### 2.1 SDK 依赖

```yaml
# pubspec.yaml
dependencies:
  amap_flutter_map: ^3.0.0      ✅ 已配置
  amap_flutter_location: ^3.0.0  ✅ 已配置
```

### 2.2 离线策略配置

| 配置项 | 设定值 | 状态 |
|--------|--------|------|
| 下载范围 | 路线周边 500m | ✅ |
| 地图级别 | 14-15级 | ✅ |
| 预估大小 | 5-20MB/路线 | ✅ |
| 存储路径 | 本地缓存 | ✅ |

### 2.3 高德离线能力

| 层级 | 级别 | 内容 | 山径需求 |
|------|------|------|----------|
| 基础道路 | 13级 | 主要道路 | 可选 |
| 详细道路 | 14-15级 | 小路、步道 | ✅ 必需 |
| 地形细节 | 16级 | 建筑物 | 可选 |

---

## 3. 离线功能测试步骤

### 3.1 下载功能测试

| 步骤 | 操作 | 预期结果 | 状态 |
|------|------|----------|------|
| 1 | 点击地图页下载按钮 | 弹出下载确认弹窗 | ✅ UI已实现 |
| 2 | 点击"开始下载" | 显示进度条 | ⚠️ 模拟实现 |
| 3 | 等待下载完成 | 提示"下载完成" | ✅ SnackBar提示 |
| 4 | 重复点击下载 | 需处理重复下载逻辑 | ⚠️ 待完善 |

### 3.2 离线使用测试

| 步骤 | 操作 | 预期结果 | 状态 |
|------|------|----------|------|
| 1 | 开启飞行模式 | 地图正常显示 | ⚠️ 需真机测试 |
| 2 | 定位功能 | GPS定位可用 | ✅ 依赖已配置 |
| 3 | 路线显示 | 已下载路线渲染 | ⚠️ 需真机测试 |
| 4 | 缩放操作 | 离线级别内流畅 | ⚠️ 需真机测试 |

### 3.3 边界情况

| 场景 | 处理方式 | 状态 |
|------|----------|------|
| 存储空间不足 | 提示清理空间 | ⚠️ 待实现 |
| 下载中断 | 断点续传或重试 | ⚠️ 待实现 |
| 弱网环境 | 优先使用离线数据 | ⚠️ 待实现 |

---

## 4. 验证结论

### 4.1 已完成项

| 项目 | 状态 |
|------|------|
| 下载按钮 UI | ✅ 地图页 + 详情页 |
| 下载弹窗 | ✅ 路线/范围/大小显示 |
| SDK 依赖 | ✅ amap_flutter_map 已配置 |
| 下载策略文档 | ✅ 500m/14-15级/5-20MB |

### 4.2 待完成项

| 项目 | 优先级 |
|------|--------|
| 接入高德离线地图 SDK API | P0 |
| 真实下载进度回调 | P0 |
| 离线数据存储管理 | P1 |
| 重复下载处理 | P1 |
| 存储空间检查 | P2 |

### 4.3 真机测试需求

需要以下环境进行完整验证:
- Android 10+ / iOS 14+ 设备
- 存储空间 > 500MB
- 高德 API Key 有效
- 飞行模式测试能力

---

## 5. 下一步行动

1. **接入 SDK**: 集成高德 `OfflineMapManager` API
2. **实现下载**: 替换模拟进度为真实下载
3. **存储管理**: 实现离线包本地存储
4. **真机测试**: 执行完整离线功能测试

---

*验证完成*
