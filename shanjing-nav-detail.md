# 山径APP - 导航模块详细设计

## 1. 核心挑战

| 挑战 | 说明 | 解决方案 |
|------|------|----------|
| **离线可用** | 山区无信号 | 预下载离线地图包 |
| **轨迹跟随** | GPS漂移、信号遮挡 | 轨迹匹配算法 + 惯导补偿 |
| **路口辨识** | 林冠茂密、视野受限 | 关键节点预标注 + 图片对比 |
| **电量消耗** | GPS持续定位 | 智能采样 + 省电模式 |

---

## 2. 技术方案

### 2.1 离线地图

#### 地图数据
| 层级 | 内容 | 大小 |
|------|------|------|
| L1 基础 | 道路、水系、建筑轮廓 | ~10MB/城市 |
| L2 详细 | 小路、步道、POI | ~20MB/城市 |
| L3 卫星 | 卫星影像切片 | ~100MB/城市 |
| L4 等高线 | 10米等高线 | ~5MB/城市 |

**下载策略**:
- 按路线下载：只下载路线周边500m范围
- 按城市下载：全城市覆盖
- 自动缓存：浏览过的路线自动缓存L1+L2

#### 存储格式
```
/offline_maps
  /{city_id}
    base.mbtiles      # 基础地图
    detail.mbtiles    # 详细地图
    contour.mbtiles   # 等高线
    /routes
      {route_id}.gpx  # 路线轨迹
      {route_id}.json # POI数据
```

### 2.2 轨迹跟随算法

#### GPS采样
| 场景 | 频率 | 说明 |
|------|------|------|
| 正常行走 | 1秒/点 | 平衡精度与电量 |
| 高速移动 | 0.5秒/点 | 提高精度 |
| 静止 | 10秒/点 | 省电 |
| 后台 | 5秒/点 | 平衡 |

#### 轨迹匹配（Map Matching）
```
输入: GPS点 P(x, y, t)
输出: 匹配到路线上的点 M

算法:
1. 找P在路线上的最近点集 C = {c1, c2, ...}
2. 考虑历史位置，排除反向/跳跃
3. 平滑处理，消除漂移
4. 输出匹配点M + 置信度
```

#### 偏航检测
| 条件 | 判定 | 响应 |
|------|------|------|
| 距离路线 > 50m | 轻度偏航 | 震动提醒 |
| 距离路线 > 100m | 中度偏航 | 语音"您已偏离路线" |
| 距离路线 > 200m | 严重偏航 | 语音+弹窗，建议返回 |
| 持续远离路线 | 确认偏航 | 自动重新规划 |

### 2.3 路口指引

#### 关键节点标注
```json
{
  "poi_id": "p001",
  "type": "junction",
  "name": "三岔路口",
  "location": [120.123, 30.456],
  "photos": [
    "junction_p001_1.jpg",
    "junction_p001_2.jpg"
  ],
  "instructions": {
    "text": "向左转，走土路",
    "voice": "前方三岔路口，请向左转，走土路",
    "arrow": "left"
  },
  "next_poi_distance": 500
}
```

#### 语音播报时机
| 场景 | 提前距离 | 播报内容 |
|------|----------|----------|
| 关键路口 | 50m | "前方XX，请向X转" |
| POI到达 | 20m | "您已到达XX" |
| 偏航提醒 | 实时 | "您已偏离路线" |
| 进度更新 | 每500m | "已行走X公里，剩余X公里" |

---

## 3. 用户界面

### 3.1 导航主界面

```
┌─────────────────────────────┐
│  [返回]  路线名称      [更多] │
├─────────────────────────────┤
│                             │
│      ┌─────────┐           │
│      │  地图   │           │
│      │  (居中) │           │
│      │  用户位置 │          │
│      │  路线高亮 │          │
│      └─────────┘           │
│                             │
├─────────────────────────────┤
│  已走 2.5km  剩余 3.2km    │
│  用时 45min  预计 60min    │
├─────────────────────────────┤
│  [暂停]  [结束]  [拍照]    │
└─────────────────────────────┘
```

### 3.2 路口指引弹窗

```
┌─────────────────────────────┐
│  ⚠️ 关键路口                 │
├─────────────────────────────┤
│  ┌─────────────────────┐   │
│  │    实景照片          │   │
│  │   (用户视角)         │   │
│  └─────────────────────┘   │
│                             │
│  ← 向左转，走土路           │
│                             │
│  [我知道了]                 │
└─────────────────────────────┘
```

### 3.3 进度详情页

```
┌─────────────────────────────┐
│  当前进度                    │
├─────────────────────────────┤
│  里程: 2.5 / 5.7 km         │
│  海拔: 320m (↑150m)         │
│  用时: 45min                │
│  预计到达: 14:30            │
├─────────────────────────────┤
│  [海拔剖面图]                │
│     ╱╲                      │
│    ╱  ╲    ●当前位置        │
│   ╱    ╲╱                   │
├─────────────────────────────┤
│  下一个: 观景台 (500m)      │
└─────────────────────────────┘
```

---

## 4. 异常处理

| 异常 | 检测 | 处理 |
|------|------|------|
| GPS信号弱 | 精度>50m持续10s | 提示"信号弱，请开阔地带使用" |
| GPS丢失 | 无定位持续30s | 提示"GPS丢失，使用惯性导航" |
| 电量低于20% | 系统通知 | 提示"电量低，建议开启省电模式" |
| 电量低于10% | 系统通知 | 自动开启省电模式，降低采样频率 |
| 离线包缺失 | 启动导航时检测 | 提示"缺少离线地图，请先下载" |
| 轨迹文件损坏 | 加载时检测 | 提示"路线数据异常，请重新下载" |

---

## 5. 性能指标

| 指标 | 目标 | 测试方法 |
|------|------|----------|
| 地图加载 | <2秒 | 冷启动后首次加载 |
| 定位响应 | <1秒 | 从请求到显示位置 |
| 轨迹匹配 | <100ms | 单点匹配计算时间 |
| 电量消耗 | <10%/小时 | 持续导航状态 |
| 离线包大小 | <50MB/城市 | 压缩后 |

---

导航模块详细设计完成，继续路线数据还是技术架构？